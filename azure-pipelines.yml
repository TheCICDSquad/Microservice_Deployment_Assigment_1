trigger:
  - main

pool:
  name: Linux_Agent

variables:
  DOCKER_REPO: 'sashangykumar456/petclinic'
  IMAGE_TAG: '$(Build.BuildId)'
  DOCKERFILE_PATH: 'Microservice_Deployment_Assigment_1'
  APP_PATH: 'Microservice_Deployment_Assigment_1/app'

steps:
  - checkout: self   # 

  - script: |
      sudo apt update
      sudo apt install -y python3 python3-pip python3-venv
    displayName: 'Install Python & venv'

  - script: |
      cd $(APP_PATH)
      python3 -m venv venv
      source venv/bin/activate
      pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install Python dependencies in virtualenv'

  - task: DockerInstaller@0
    displayName: 'Install Docker CLI'

  - task: Docker@2
    displayName: 'Login to Docker Hub'
    inputs:
      command: login
      containerRegistry: 'dockerHubService'

  - script: |
      cd $(DOCKERFILE_PATH)
      docker build -t $(DOCKER_REPO):$(IMAGE_TAG) .
    displayName: 'Build Docker Image'

  - script: |
      docker push $(DOCKER_REPO):$(IMAGE_TAG)
    displayName: 'Push Docker Image to Docker Hub'
