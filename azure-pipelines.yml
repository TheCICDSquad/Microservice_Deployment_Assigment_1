trigger:
  - main  # or your target branch

pool:
  name: Linux_Agent  # Your self-hosted agent pool name

variables:
  DOCKER_IMAGE_NAME: fastapi-app
  DOCKER_TAG: latest
  DOCKER_REGISTRY: sashangykumar456  # Docker Hub username

steps:
  - checkout: self

  - script: |
      echo "üõ†Ô∏è Changing to app directory..."
      cd app
      echo "üê≥ Building Docker image using custom DockerFile..."
      docker build -f DockerFile -t $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_NAME):$(DOCKER_TAG) .
    displayName: 'Build Docker Image'

  - script: |
      echo $(DOCKER_PASSWORD) | docker login -u $(DOCKER_USERNAME) --password-stdin
    displayName: 'Docker Login'
    condition: and(succeeded(), ne(variables['DOCKER_USERNAME'], ''))

  - script: |
      docker push $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_NAME):$(DOCKER_TAG)
    displayName: 'Push Docker Image'
    condition: and(succeeded(), ne(variables['DOCKER_USERNAME'], ''))

  - script: |
      docker run -d -p 8000:8000 $(DOCKER_REGISTRY)/$(DOCKER_IMAGE_NAME):$(DOCKER_TAG)
    displayName: 'Run Docker Container'
