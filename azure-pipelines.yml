trigger:
  - main

pool:
  name: Linux_Agent

variables:
  DOCKER_REPO: 'sashangykumar456/petclinic'
  IMAGE_TAG: '$(Build.BuildId)'
  DOCKERFILE_PATH: 'Microservice_Deployment_Assigment_1'
  APP_PATH: 'Microservice_Deployment_Assigment_1/app'

steps:
  - checkout: self   # Required to clone your GitHub repo into the agent workspace

  - script: |
      echo "ðŸ” Current working directory: $(Build.SourcesDirectory)"
      ls -R
    displayName: 'DEBUG: List all files in repo'

  - script: |
      apt update
      apt install -y python3 python3-pip
      python3 --version
      pip3 --version
    displayName: 'Install Python and pip (No venv)'

  - script: |
      cd $(APP_PATH)
      pip3 install -r requirements.txt --break-system-packages
    displayName: 'Install Python dependencies (Global)'

  - task: DockerInstaller@0
    displayName: 'Install Docker CLI'

  - task: Docker@2
    displayName: 'Login to Docker Hub'
    inputs:
      command: login
      containerRegistry: 'dockerHubService'  # Must be configured in Azure DevOps > Service Connections

  - script: |
      cd $(DOCKERFILE_PATH)
      docker build -t $(DOCKER_REPO):$(IMAGE_TAG) .
    displayName: 'Build Docker Image'

  - script: |
      docker push $(DOCKER_REPO):$(IMAGE_TAG)
    displayName: 'Push Docker Image to Docker Hub'
